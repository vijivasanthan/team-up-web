define(["services/services","config"],function(e,t){e.factory("Logs",["$resource","$q","$filter",function(e,n,r){var i=e(t.app.host+"ddr",{},{get:{method:"GET",params:{},isArray:!0}}),s=function(e){var t=[],n=function(e){return/@/.test(e)?e.split("@")[0]:e},i=function(e){if(e&&e!=0){var t=moment.duration(e),n=function(e){return String(e).length==1?"0"+String(e):e};return{presentation:(t.hours()==0?"00":n(t.hours()))+":"+(t.minutes()==0?"00":n(t.minutes()))+":"+n(t.seconds()),stamp:e}}return{presentation:"00:00:00",stamp:0}},s=null;angular.forEach(e,function(e){var o=angular.fromJson(e.additionalInfo),u=o?o.hasOwnProperty("trackingToken")?o.trackingToken:e.start:e.start,a=u==s?o?o.hasOwnProperty("trackingToken")?!0:!1:!1:!1;s=u;var f={trackingToken:u,tracked:a,from:n(e.fromAddress),started:{date:r("date")(e.start,"medium"),stamp:e.start}};angular.forEach(e.statusPerAddress,function(e){f.status=e}),angular.forEach(angular.fromJson(e.toAddressString),function(e,t){f.to=n(t)}),f.duration=i(e.duration),t.push(f)});var o=_.groupBy(t,"trackingToken");_.each(t,function(e){typeof e.trackingToken!="number"&&(e.records=[],_.each(o[e.trackingToken],function(t){e.records.push({from:t.from,started:{date:t.started.date,stamp:t.started.stamp},status:t.status,to:t.to,duration:{presentation:t.duration.presentation,stamp:t.duration.stamp}})}))}),_.each(t,function(e){e.records&&e.records.reverse(),e.records&&(e.from=e.records[0].from,e.started.date=e.records[0].started.date,e.started.stamp=e.records[0].started.stamp,e.status=e.records[0].status,e.to=e.records[0].to,e.duration.presentation=e.records[0].duration.presentation,e.duration.stamp=e.records[0].duration.stamp,e.records.shift())});var u=_.indexBy(t,"trackingToken"),a=[];return _.each(u,function(e){a.push(e)}),r("orderBy")(a,"started.stamp"),a};return i.prototype.fetch=function(e){var t=n.defer();return e||(e={end:(new Date.now).getTime(),start:(new Date.today).addDays(-7).getTime()}),i.get({startTime:e.start,endTime:e.end},function(n){var r={logs:s(n),synced:Date.now().getTime(),periods:e};t.resolve(r)},function(e){t.resolve({error:e})}),t.promise},new i}])});